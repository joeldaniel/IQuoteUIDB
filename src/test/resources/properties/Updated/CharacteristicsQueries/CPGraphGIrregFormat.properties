Query=   WITH cte AS  \
				  ( \
				  SELECT a.IdPSCmpChild, a.IdPSCmpParent \
				  FROM qttTMPSCmpLink a \
				  WHERE a.IdPSCmpParent in  \
						(select  qttTMPSCmp.IdPSCmp \
						 From qttTMQuote  \
						 Join qttTMItem on qttTMItem.IdItem = qttTMQuote.IdItem \
						 Join qttTMItemOption on qttTMItem.IdItem = qttTMItemOption.IdItem \
						 Join qttTMItemOptionQty on qttTMItemOption.IdItemOption = qttTMItemOptionQty.IdItemOption \
						 Join qttTMItemOptionQtyPSCmp on qttTMItemOptionQty.IdItemOptionQty = qttTMItemOptionQtyPSCmp.IdItemOptionQty \
						 Join qttTMPSCmp on qttTMItemOptionQtyPSCmp.IdPSCmp = qttTMPSCmp.IdPSCmp \
						 where qttTMQuote.idQuote = '##Estimate##'    \
						) \
				  UNION ALL \
				  SELECT a.IdPSCmpChild, a.IdPSCmpParent \
				  FROM qttTMPSCmpLink a JOIN cte c ON a.IdPSCmpParent = c.IdPSCmpChild \
				  ) \
				  select qttTMItemOption.Description as OptionDescription, \
				         qttTMPSCmp.Description as ComponentDescription, \
						 qttTMPSCmp.isFinal as ComponentFinal, \
				         qttTMPSCmp.PSCMpOrder as ComponentOrder, \
						 qttTCPSCmptype.Description as ComponentTypeDesc, \
						 ISNull(qttTCPSCaracType.DisplayDescription ,qttTCPSCaracType.Description) as \ CharacteristicDesc, \
						 qttTMPSCmpCarac.idPSCmpCarac,		  \
						 qttTMCPGraphGIrregFormat.Width/25.4 as ClosedWidth, \
						 qttTMCPGraphGIrregFormat.Height/25.4 as ClosedHeight, \
						 qttTMCPGraphGIrregFormat.WidthOpened/25.4 as OpenedWidth, \
						 qttTMCPGraphGIrregFormat.HeightOpened/25.4 as OpenedHeight,		   \
						 qttTMCPGraphGIrregFormat.ToolCostPercent as DieApportionment, \
						 qttTMGraphGIrregFormatOption.KnifeCode, \
						 qttTMGraphGIrregFormatOption.CanChangeKnife as EditDie, \
						 qttTMGraphGIrregFormatOption.DisposalWidth/25.4 as SizeWidth, \
						 qttTMGraphGIrregFormatOption.DisposalHeight/25.4 as SizeHeight, \
						 qttTMGraphGIrregFormatOption.DisposalQty as NumberUp, \
						 qttTMGraphGIrregFormatOption.KnifeLength as DieCutterLength, \
						 qttTMGraphGIrregFormatOption.FixedKnifeLength as FixedDieLength, \
				  	     CASE  \
				           WHEN qttTMGraphGIrregFormatOption.KnifeAssemblyType =  0 THEN 'Easy' \
				           WHEN qttTMGraphGIrregFormatOption.KnifeAssemblyType =  1 THEN 'Medium' \
						   WHEN qttTMGraphGIrregFormatOption.KnifeAssemblyType =  2 THEN 'Difficult' \
				         END as Difficulty, \
						 qttTMGraphGIrregFormatOption.MediaUseLevel as Utilization, \
						 qttTMGraphGIrregFormatOption.KnifeExisting as DoNotChargeForDie, \
						 qttTMGraphGIrregFormatOption.Inverted as Inverted, \
						 qttTMGraphGIrregFormatOption.SingleSimulation as FixNumberUp, \
						 qttTMGraphGIrregFormatOption.HasDifferentDieSpecFormat as HasADifferentSlot, \
						 qttTMGraphGIrregFormatOption.AutoGeneratedOption as AutoGenerated, \
						 qttTMGraphGIrregFormatOption.Note as Notes, \
						 qttTMGraphGIrregFormatOption.DieSpecDisposalWidth as DieSizeWidth, \
						 qttTMGraphGIrregFormatOption.DieSpecDisposalHeight as DieSizeHeight, \
						 qttTMGraphGIrregFormatOption.DieSpecDisposalQty as OriginalNumberUp, \
						 qttTMGraphGIrregFormatOption.DieSpecLenght as OriginalDieLength \
				  from qttTMPSCmp \
				  left join qttTMPS on qttTMPSCmp.IdPS = qttTMPS.IdPS \
				  left join qttTMItemOption on qttTMPS.IdPS = qttTMItemOption.IdPS  \
				  join qttTCPSCmptype on qttTMPSCmp.idPSCmptype = qttTCPSCmptype.idPSCmptype \
				  Join qttTMPSCmpCarac on qttTMPSCmp.IdPSCmp = qttTMPSCmpCarac.IdPSCmp \
				  Join qttTCPSCaracType on qttTCPSCaracType.IdPSCaracType = qttTMPSCmpCarac.IdPSCaracType \
				  Join qttTMCPGraphGIrregFormat on qttTMPSCmpCarac.IdPSCmpCarac = qttTMCPGraphGIrregFormat.IdPSCmpCarac \
				  left Join qttTMGraphGIrregFormatOption on qttTMPSCmpCarac.IdPSCmpCarac = \ qttTMGraphGIrregFormatOption.IdPSCmpCarac \
				  where qttTMPSCmp.idpscmp \
				  in \
				  ( \
				  SELECT IdPSCmpParent as ComponentID from cte \
				  Union \
				  select IdPSCmpChild from cte    \
				  join qttTMPscmp as Component on cte.IdPSCmpParent = Component.idpscmp \
				  Union \
				  		( \
						 select  qttTMPSCmp.IdPSCmp \
						 From qttTMQuote  \
						 Join qttTMItem on qttTMItem.IdItem = qttTMQuote.IdItem \
						 Join qttTMItemOption on qttTMItem.IdItem = qttTMItemOption.IdItem \
						 Join qttTMPSCmp on qttTMItemOption.IdPS = qttTMPSCmp.IdPS \
						 where qttTMQuote.idQuote = '##Estimate##'    \
						) \
				  )   \
				   and (qttTCPSCaracType.DisplayDescription = '##CharteristicDescp##' or qttTCPSCaracType.Description='##CharteristicDescp##') \
				and qttTMPSCmp.PSCMpOrder = '##CompOrder##'  \
				and   qttTMItemOption.IdItemOption = '##IdItemOption##'